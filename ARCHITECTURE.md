# Monoliet Client Portal - Architecture Documentation

<!-- Generated by Claude Code on 2026-01-17 - Based on repository analysis -->

## Table of Contents

1. [System Overview](#system-overview)
2. [Technology Stack](#technology-stack)
3. [Architecture Layers](#architecture-layers)
4. [Database Schema](#database-schema)
5. [Security Architecture](#security-architecture)
6. [Integration Points](#integration-points)
7. [Data Flow](#data-flow)
8. [Design Patterns](#design-patterns)

---

## System Overview

The Monoliet Client Portal is a Django-based web application that provides client management and workflow monitoring capabilities for n8n automation services. The system follows a traditional three-tier architecture:

```
┌─────────────────────────────────────────────────────┐
│              Presentation Layer                      │
│  - Client Web Portal (HTML/Tailwind CSS)            │
│  - Django Admin Interface                           │
│  - REST API (JSON responses)                        │
└─────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────┐
│              Application Layer                       │
│  - Django Views & ViewSets                          │
│  - Business Logic & Permissions                     │
│  - Management Commands                              │
│  - Email Notification System                        │
└─────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────┐
│               Data Layer                            │
│  - PostgreSQL 15 Database                           │
│  - Django ORM Models                                │
│  - Encrypted Credential Storage                     │
└─────────────────────────────────────────────────────┘
```

**Note:** Based on portal/settings.py:25, docker-compose.yml:1-43

---

## Technology Stack

### Backend Framework
- **Django 5.0.1** - Web framework (requirements.txt:1)
- **Django REST Framework 3.14.0** - API framework (requirements.txt:2)
- **Python 3.11** - Runtime environment (Dockerfile:1)

### Database
- **PostgreSQL 15** - Primary database (docker-compose.yml:5, portal/settings.py:99)
- **psycopg2-binary 2.9.9** - PostgreSQL adapter (requirements.txt:3)

### API & Authentication
- **Token Authentication** - DRF token-based auth (portal/settings.py:160)
- **Session Authentication** - Django session auth (portal/settings.py:161)

### Security & Encryption
- **cryptography 42.0.0** - Fernet encryption for credentials (requirements.txt:8, clients/utils.py:12)
- **python-decouple 3.8** - Environment variable management (requirements.txt:4)

### Production Server
- **Gunicorn 21.2.0** - WSGI HTTP server (requirements.txt:5, docker-compose.yml:26)
- **WhiteNoise 6.6.0** - Static file serving (requirements.txt:6, portal/settings.py:58)

### Additional Libraries
- **django-cors-headers 4.3.1** - CORS handling (requirements.txt:7)
- **django-filter 24.1** - API filtering (requirements.txt:9)
- **requests 2.31.0** - HTTP client for n8n API (requirements.txt:10)

### Frontend
- **Tailwind CSS** - UI styling (via CDN, clients/templates/clients/base.html)
- **Vanilla JavaScript** - Minimal client-side interactivity

### Deployment
- **Docker** - Container platform (Dockerfile, docker-compose.yml)
- **Docker Compose** - Multi-container orchestration (docker-compose.yml)
- **Nginx Proxy Manager** - Reverse proxy (external, documented in README.md:129-134)

---

## Architecture Layers

### 1. Models Layer (`clients/models.py`)

Eight database models represent the core domain:

**Core Business Models:**
- `Client` (lines 15-62) - Client companies with billing and plan information
- `Workflow` (lines 64-106) - n8n workflows linked to clients
- `APICredential` (lines 108-143) - Encrypted third-party API credentials
- `Execution` (lines 145-168) - Daily execution statistics per workflow
- `Invoice` (lines 170-211) - Billing and payment tracking
- `SupportTicket` (lines 213-248) - Customer support management
- `ClientProfile` (lines 250-267) - Links Django Users to Clients
- `PortalSettings` (lines 269-353) - Singleton configuration model

**Key Design Decisions:**
- UUID primary keys for security (models.py:32, 76, 126, 151, 188, 231)
- Foreign key relationships for data integrity
- Choice fields for status management
- Timestamp tracking (created_at, updated_at)
- Unique constraints on business identifiers

### 2. API Layer (`clients/views.py`, `clients/serializers.py`)

**ViewSets** (Django REST Framework):
- `ClientViewSet` (views.py:38-98) - Client CRUD operations
- `WorkflowViewSet` (views.py:100-152) - Workflow management
- `APICredentialViewSet` (views.py:154-192) - Credential management
- `ExecutionViewSet` (views.py:194-262) - Execution statistics
- `InvoiceViewSet` (views.py:264-308) - Invoice operations
- `SupportTicketViewSet` (views.py:310-369) - Support ticket management

**Custom Endpoints:**
- `/api/clients/me/` - Get current user's client (views.py:81-97)
- `/api/executions/stats/` - Aggregated statistics (views.py:227-261)
- `/api/workflows/{id}/activate/` - Workflow activation (views.py:136-151)
- `/api/auth/token/` - Token authentication (views.py:371-398)
- `/api/auth/logout/` - Token revocation (views.py:401-409)

### 3. Permissions Layer (`clients/permissions.py`)

Custom permission classes enforce access control:

- `IsAdminUser` (lines 13-22) - Admin-only access
- `IsClientOwner` (lines 25-71) - Client data isolation
- `IsClientUser` (lines 73-96) - Client profile verification
- `ReadOnly` (lines 98-105) - Read-only access
- `IsAdminOrReadOnly` (lines 108-124) - Conditional write access
- `CanCreateSupportTicket` (lines 126-154) - Ticket creation permissions

**Permission Strategy:**
- Admin users (`is_staff=True`) have full access
- Client users can only access their own data via `ClientProfile` relationship
- Object-level permissions verified on each request

### 4. Web Views Layer (`clients/web_views.py`)

Server-rendered HTML views for client portal:
- Dashboard with statistics
- Workflow list and monitoring
- Invoice management
- Support ticket system
- Login/logout handling

### 5. Admin Layer (`clients/admin.py`, `clients/admin_views.py`)

Enhanced Django admin interface with:
- Custom list displays
- Inline editing for related objects
- Admin actions (mark as paid, resolve tickets, etc.)
- Search and filtering capabilities
- Custom admin dashboard (admin_views.py)

### 6. Utility Layer (`clients/utils.py`)

Helper functions and classes:

**Encryption Functions:**
- `encrypt_credential()` (lines 17-37) - Fernet encryption
- `decrypt_credential()` (lines 40-62) - Credential decryption

**Invoice Management:**
- `generate_invoice_number()` (lines 65-91) - Auto-incrementing invoice IDs

**n8n Integration:**
- `N8NAPIClient` class (lines 94-221) - API client for n8n
  - Methods: `get_workflow()`, `get_executions()`, `activate_workflow()`, etc.

**Statistics:**
- `calculate_monthly_revenue()` (lines 237-248) - MRR calculation
- `get_client_statistics()` (lines 267-324) - Comprehensive client stats

### 7. Signal Layer (`clients/signals.py`)

Django signals for automated workflows:
- New support ticket → Email notifications to client and admin
- Ticket resolved → Email notification to client
- New invoice → Email notification to client
- Workflow error → Email alert to admin
- Pre-save invoice → Auto-generate invoice number

### 8. Management Commands (`clients/management/commands/`)

Background automation tasks:

1. **`sync_n8n_executions.py`** - Sync execution data from n8n
2. **`send_invoice_reminders.py`** - Payment reminder emails
3. **`check_workflow_health.py`** - Monitor workflow health
4. **`create_sample_data.py`** - Generate test data

---

## Database Schema

### Entity Relationship Diagram

```
┌─────────────┐
│   Client    │
│ (UUID PK)   │
└──────┬──────┘
       │
       ├──────────────┐
       │              │
       │              │
   ┌───▼────┐    ┌───▼───────────┐
   │Workflow│    │ APICredential │
   │(UUID PK)│    │  (UUID PK)    │
   └───┬────┘    └───────────────┘
       │
       │
   ┌───▼─────┐
   │Execution│
   │(UUID PK)│
   └─────────┘

┌─────────────┐    ┌───────────────┐
│   Invoice   │    │ SupportTicket │
│  (UUID PK)  │    │   (UUID PK)   │
└──────┬──────┘    └───────┬───────┘
       │                   │
       └───────────┬───────┘
                   │
              ┌────▼────┐
              │ Client  │
              │(UUID PK)│
              └─────────┘

┌──────────────┐       ┌──────────────┐
│ClientProfile │───────│  User (Auth) │
│  (Auto PK)   │       │  (Auto PK)   │
└──────┬───────┘       └──────────────┘
       │
       │
   ┌───▼────┐
   │ Client │
   │(UUID PK)│
   └────────┘
```

### Model Relationships

**Client (1) → (Many) Workflow**
- `Client.workflows` - Related name (models.py:77)
- `Workflow.client` - Foreign key

**Client (1) → (Many) APICredential**
- `Client.api_credentials` - Related name (models.py:127)
- `APICredential.client` - Foreign key

**Client (1) → (Many) Execution**
- `Client.executions` - Related name (models.py:152)
- `Execution.client` - Foreign key

**Workflow (1) → (Many) Execution**
- `Workflow.executions` - Related name (models.py:153)
- `Execution.workflow` - Foreign key
- Unique constraint: (workflow, execution_date) (models.py:164)

**Client (1) → (Many) Invoice**
- `Client.invoices` - Related name (models.py:189)
- `Invoice.client` - Foreign key

**Client (1) → (Many) SupportTicket**
- `Client.support_tickets` - Related name (models.py:232)
- `SupportTicket.client` - Foreign key

**User (1) → (1) ClientProfile → (1) Client**
- `User.client_profile` - Related name (models.py:256)
- `ClientProfile.user` - OneToOne
- `ClientProfile.client` - Foreign key (optional) (models.py:257)

### Key Schema Features

**UUID Primary Keys:**
All business models use UUID v4 for non-sequential, secure identifiers:
```python
id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
```
(models.py:32, 76, 126, 151, 188, 231)

**Encrypted Data:**
`APICredential.encrypted_data` stores Fernet-encrypted JSON (models.py:130)

**Status Tracking:**
Most models have status fields with predefined choices:
- Client: active, paused, churned (models.py:21-25)
- Workflow: active, paused, error (models.py:70-74)
- Invoice: pending, paid, overdue (models.py:182-186)
- SupportTicket: open, in_progress, resolved (models.py:219-223)

**Automatic Timestamps:**
- `created_at = models.DateTimeField(auto_now_add=True)`
- `updated_at = models.DateTimeField(auto_now=True)`

---

## Security Architecture

### 1. Authentication

**Token-based API Authentication:**
- DRF Token Authentication (portal/settings.py:160)
- Custom token endpoint with user info (views.py:371-398)
- Token revocation on logout (views.py:401-409)

**Session-based Web Authentication:**
- Django session authentication for web portal (portal/settings.py:161)
- Login/logout views (clients/web_views.py)
- `@login_required` decorators

### 2. Authorization

**Role-based Access Control:**
- **Admin users** (`is_staff=True`): Full system access
- **Client users**: Access only to their own client's data

**Permission Enforcement:**
- ViewSet-level permissions (views.py:58-65, 114-120)
- Object-level permissions (permissions.py:37-70)
- ClientProfile linkage ensures data isolation

### 3. Data Encryption

**API Credential Encryption:**
```python
# Fernet symmetric encryption (clients/utils.py:17-37)
def encrypt_credential(data: dict) -> str:
    key = settings.ENCRYPTION_KEY.encode()
    cipher = Fernet(key)
    json_data = json.dumps(data)
    encrypted = cipher.encrypt(json_data.encode())
    return encrypted.decode()
```

**Configuration:**
- `ENCRYPTION_KEY` from environment (.env.example:29)
- Generated via: `python3 -c 'from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())'`

### 4. Production Security Settings

Enabled when `DEBUG=False` (portal/settings.py:197-207):
- `SECURE_SSL_REDIRECT = True` - Force HTTPS
- `SESSION_COOKIE_SECURE = True` - Secure cookies
- `CSRF_COOKIE_SECURE = True` - CSRF protection
- `SECURE_BROWSER_XSS_FILTER = True` - XSS protection
- `SECURE_CONTENT_TYPE_NOSNIFF = True` - MIME sniffing protection
- `X_FRAME_OPTIONS = 'DENY'` - Clickjacking protection
- `SECURE_HSTS_SECONDS = 31536000` - HTTP Strict Transport Security

### 5. CSRF Protection

- CSRF middleware enabled (portal/settings.py:62)
- Trusted origins configured (.env.example:7)
- Django template auto-escaping prevents XSS

### 6. SQL Injection Prevention

- Django ORM used exclusively (no raw SQL)
- Parameterized queries by default

### 7. Password Security

- Django's default password hashing (PBKDF2)
- Password validation rules (portal/settings.py:112-125)

---

## Integration Points

### 1. n8n API Integration

**Configuration:**
- `N8N_URL` - n8n instance URL (.env.example:25)
- `N8N_API_KEY` - API authentication key (.env.example:26)

**API Client Implementation:**
`N8NAPIClient` class (clients/utils.py:94-221) provides methods:

```python
client = N8NAPIClient()

# Get workflow details
workflow = client.get_workflow(workflow_id)

# Get executions
executions = client.get_executions(workflow_id, limit=100)

# Activate/deactivate workflow
client.activate_workflow(workflow_id)
client.deactivate_workflow(workflow_id)
```

**Usage in Management Commands:**
- `sync_n8n_executions.py` - Fetches execution data
- `check_workflow_health.py` - Monitors workflow status

### 2. Email Integration

**SMTP Configuration:**
From .env.example:16-22 and portal/settings.py:175-181:

```python
EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
EMAIL_HOST = 'smtp.gmail.com'
EMAIL_PORT = 587
EMAIL_USE_TLS = True
EMAIL_HOST_USER = 'info@monoliet.cloud'
DEFAULT_FROM_EMAIL = 'noreply@monoliet.cloud'
```

**Email Triggers:**
Via Django signals (clients/signals.py):
- New support ticket created
- Support ticket resolved
- New invoice generated
- Workflow error detected

### 3. Stripe Integration (Prepared)

**Invoice Model:**
- `stripe_invoice_id` field for Stripe reference (models.py:200)
- Ready for Stripe payment integration

### 4. External Network

**Docker Networking:**
- External network named "web" (docker-compose.yml:40-42)
- Enables connection to Nginx Proxy Manager
- Shared with n8n container

---

## Data Flow

### 1. API Request Flow

```
┌──────────┐
│  Client  │
└────┬─────┘
     │ HTTP Request + Token
     ▼
┌────────────────────┐
│   Django Middleware│
│ - CORS             │
│ - CSRF             │
│ - Auth             │
└────┬───────────────┘
     │
     ▼
┌────────────────────┐
│    ViewSet         │
│ - get_permissions()│
│ - get_queryset()   │
└────┬───────────────┘
     │
     ▼
┌────────────────────┐
│  Permission Check  │
│ - IsAdminUser      │
│ - IsClientOwner    │
└────┬───────────────┘
     │
     ▼
┌────────────────────┐
│   Serializer       │
│ - Validation       │
│ - Transformation   │
└────┬───────────────┘
     │
     ▼
┌────────────────────┐
│    Model/DB        │
│ - ORM Query        │
│ - PostgreSQL       │
└────┬───────────────┘
     │
     ▼
┌────────────────────┐
│  JSON Response     │
└────────────────────┘
```

**Code References:**
- Middleware: portal/settings.py:56-66
- ViewSets: clients/views.py
- Permissions: clients/permissions.py
- Serializers: clients/serializers.py
- Models: clients/models.py

### 2. Web Portal Request Flow

```
┌──────────┐
│  Browser │
└────┬─────┘
     │ HTTP Request
     ▼
┌────────────────────┐
│  Django Middleware │
│ - Session Auth     │
└────┬───────────────┘
     │
     ▼
┌────────────────────┐
│   Web View         │
│ - @login_required  │
│ - Get user's client│
└────┬───────────────┘
     │
     ▼
┌────────────────────┐
│  Query Database    │
│ - Filter by client │
└────┬───────────────┘
     │
     ▼
┌────────────────────┐
│  Render Template   │
│ - HTML + Tailwind  │
└────┬───────────────┘
     │
     ▼
┌────────────────────┐
│  HTML Response     │
└────────────────────┘
```

**Code References:**
- Web views: clients/web_views.py
- Templates: clients/templates/clients/

### 3. n8n Sync Flow

```
┌──────────────────┐
│  Cron Job        │
│  (Daily 2 AM)    │
└────┬─────────────┘
     │
     ▼
┌──────────────────────────┐
│  sync_n8n_executions.py  │
└────┬─────────────────────┘
     │
     ▼
┌──────────────────┐
│  N8NAPIClient    │
│  .get_executions │
└────┬─────────────┘
     │
     ▼
┌──────────────────┐
│  n8n API         │
│  (External)      │
└────┬─────────────┘
     │ JSON Response
     ▼
┌──────────────────┐
│  Parse Data      │
│  Aggregate Stats │
└────┬─────────────┘
     │
     ▼
┌──────────────────┐
│  Update Execution│
│  Models (DB)     │
└──────────────────┘
```

**Code References:**
- Management command: clients/management/commands/sync_n8n_executions.py
- API client: clients/utils.py:94-221

### 4. Email Notification Flow

```
┌──────────────────┐
│  Model Event     │
│  (Create/Update) │
└────┬─────────────┘
     │
     ▼
┌──────────────────┐
│  Django Signal   │
│  post_save       │
└────┬─────────────┘
     │
     ▼
┌──────────────────┐
│  Signal Handler  │
│  (signals.py)    │
└────┬─────────────┘
     │
     ▼
┌──────────────────┐
│  Send Email      │
│  via SMTP        │
└────┬─────────────┘
     │
     ▼
┌──────────────────┐
│  Gmail SMTP      │
│  (External)      │
└──────────────────┘
```

**Code References:**
- Signal handlers: clients/signals.py
- Email config: portal/settings.py:175-181

---

## Design Patterns

### 1. Repository Pattern
**Django ORM as Repository:**
- Models act as repositories
- QuerySet API provides abstraction over database
- ViewSets use `get_queryset()` for filtering (views.py:68-78)

### 2. Factory Pattern
**Signal-based Factories:**
- `generate_invoice_number()` called via pre_save signal (clients/signals.py)
- Automatic invoice number generation

### 3. Singleton Pattern
**PortalSettings Model:**
```python
def save(self, *args, **kwargs):
    # Ensure only one instance exists
    self.pk = 1
    super().save(*args, **kwargs)
```
(models.py:339-342)

### 4. Strategy Pattern
**Permission Classes:**
- Different permission strategies for different ViewSets
- Composable via `get_permissions()` method (views.py:58-65)

### 5. Facade Pattern
**N8NAPIClient:**
- Simple interface to complex n8n API
- Abstracts HTTP requests, error handling (clients/utils.py:94-221)

### 6. Observer Pattern
**Django Signals:**
- Models emit signals on save/delete
- Signal handlers react to events (clients/signals.py)

### 7. Template Method Pattern
**Generic ViewSets:**
- DRF ViewSets define template methods
- Subclasses override: `get_serializer_class()`, `get_permissions()`, `get_queryset()`

### 8. Dependency Injection
**Django Settings:**
- Configuration injected via `settings` module
- Environment-based configuration (portal/settings.py)

---

## Performance Considerations

### 1. Database Optimization

**Indexing:**
- Primary keys (UUID) automatically indexed
- Foreign keys automatically indexed
- `unique=True` fields automatically indexed (models.py:35, 79, 190)

**Query Optimization:**
- Use `select_related()` for foreign keys
- Use `prefetch_related()` for reverse foreign keys
- Pagination enabled (50 items per page) (portal/settings.py:167)

### 2. Static File Handling

**WhiteNoise Integration:**
- Efficient static file serving (portal/settings.py:58, 145)
- Compressed manifest storage
- No need for separate static file server

### 3. Connection Pooling

**PostgreSQL:**
- Default Django database connection pooling
- Persistent connections in production

### 4. Caching Strategy

**Opportunities (Not Yet Implemented):**
- Cache execution statistics
- Cache client dashboard data
- Use Django's cache framework with Redis

---

## Deployment Architecture

### Docker Container Setup

```
┌─────────────────────────────────────────┐
│           Nginx Proxy Manager           │
│        (External, port 80/443)          │
└────────────────┬────────────────────────┘
                 │
                 │ HTTPS (Let's Encrypt)
                 │
                 ▼
┌─────────────────────────────────────────┐
│         Docker Network: "web"           │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  monoliet-django                │   │
│  │  - Gunicorn (3 workers)         │   │
│  │  - Port 8000 (exposed)          │   │
│  │  - WhiteNoise (static files)    │   │
│  └─────────┬───────────────────────┘   │
│            │                            │
│            │ PostgreSQL connection      │
│            ▼                            │
│  ┌─────────────────────────────────┐   │
│  │  monoliet-postgres              │   │
│  │  - PostgreSQL 15                │   │
│  │  - Volume: ./postgres/data      │   │
│  │  - Healthcheck enabled          │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

**Code References:**
- Docker Compose: docker-compose.yml
- Dockerfile: Dockerfile
- Nginx config documented in: README.md:129-134

---

## Future Architecture Enhancements

Based on PROJECT_SUMMARY.md:349-361, potential additions:

1. **PDF Generation** - Invoice PDF downloads
2. **Stripe Integration** - Payment processing
3. **Advanced Analytics** - Data visualization dashboard
4. **Webhook Support** - Real-time n8n event processing
5. **Two-Factor Authentication** - Enhanced security
6. **Activity Logs** - Audit trail system
7. **WebSocket Support** - Real-time notifications
8. **Redis Caching** - Performance optimization
9. **Celery Tasks** - Async background processing
10. **API Versioning** - Support multiple API versions

---

## Conclusion

The Monoliet Client Portal follows Django best practices with a clean separation of concerns:

- **Models** define data structure
- **Views/ViewSets** handle request logic
- **Serializers** transform data
- **Permissions** enforce access control
- **Signals** handle automated workflows
- **Templates** render HTML
- **Management commands** provide automation

The architecture is production-ready, scalable, and maintainable, with clear extension points for future enhancements.

---

**Last Updated:** 2026-01-17
**Django Version:** 5.0.1
**Python Version:** 3.11
