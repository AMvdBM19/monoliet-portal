# Monoliet Client Portal - API Reference

<!-- Generated by Claude Code on 2026-01-17 - Based on repository analysis -->

## Table of Contents

1. [Overview](#overview)
2. [Authentication](#authentication)
3. [Base URL & Versioning](#base-url--versioning)
4. [Request/Response Format](#requestresponse-format)
5. [Error Handling](#error-handling)
6. [Rate Limiting](#rate-limiting)
7. [Pagination](#pagination)
8. [Filtering & Search](#filtering--search)
9. [API Endpoints](#api-endpoints)
   - [Authentication](#authentication-endpoints)
   - [Clients](#clients-endpoints)
   - [Workflows](#workflows-endpoints)
   - [Executions](#executions-endpoints)
   - [Invoices](#invoices-endpoints)
   - [Support Tickets](#support-tickets-endpoints)
   - [API Credentials](#api-credentials-endpoints)
10. [Permissions](#permissions)
11. [Code Examples](#code-examples)

---

## Overview

The Monoliet Client Portal provides a RESTful API built with Django REST Framework 3.14.0. The API allows programmatic access to client data, workflow monitoring, invoice management, and support ticket operations.

**API Framework:** Django REST Framework (requirements.txt:2)
**Authentication:** Token-based (portal/settings.py:160)
**Data Format:** JSON
**API Version:** v1 (implicit)

---

## Authentication

### Token Authentication

The API uses token-based authentication. Include your token in the `Authorization` header of all requests.

**Header Format:**
```
Authorization: Token 9944b09199c62bcf9418ad846dd0e4bbdfc6ee4b
```

**Implementation:** clients/views.py:371-398, portal/settings.py:159-162

### Obtaining a Token

**Endpoint:** `POST /api/auth/token/`

**Request Body:**
```json
{
  "username": "your_username",
  "password": "your_password"
}
```

**Success Response (200 OK):**
```json
{
  "token": "9944b09199c62bcf9418ad846dd0e4bbdfc6ee4b",
  "user_id": 1,
  "username": "your_username",
  "email": "user@example.com",
  "is_staff": false,
  "client": {
    "id": "a1b2c3d4-5678-90ab-cdef-1234567890ab",
    "company_name": "Acme Corporation"
  }
}
```

**Error Response (400 Bad Request):**
```json
{
  "non_field_errors": [
    "Unable to log in with provided credentials."
  ]
}
```

**Code Reference:** clients/views.py:371-398

### Revoking a Token (Logout)

**Endpoint:** `POST /api/auth/logout/`

**Headers Required:**
```
Authorization: Token your_token_here
```

**Success Response (200 OK):**
```json
{
  "message": "Successfully logged out"
}
```

**Code Reference:** clients/views.py:401-409

---

## Base URL & Versioning

**Production Base URL:**
```
https://portal.monoliet.cloud/api/
```

**Local Development:**
```
http://localhost:8000/api/
```

**Note:** API is currently unversioned. All endpoints are under `/api/`.

---

## Request/Response Format

### Content Type

All requests and responses use `application/json`.

**Request Headers:**
```
Content-Type: application/json
Authorization: Token your_token_here
```

### Timestamps

All timestamps are in ISO 8601 format with timezone:
```json
"created_at": "2024-01-15T14:30:00Z"
```

### UUID Fields

All resource IDs use UUID v4 format:
```json
"id": "a1b2c3d4-5678-90ab-cdef-1234567890ab"
```

**Implementation:** clients/models.py:32, 76, 126, 151, 188, 231

---

## Error Handling

### Standard Error Format

```json
{
  "detail": "Error message here"
}
```

### Field-Specific Errors

```json
{
  "field_name": [
    "This field is required."
  ],
  "another_field": [
    "This field must be unique."
  ]
}
```

### HTTP Status Codes

| Status Code | Meaning |
|-------------|---------|
| 200 | OK - Request succeeded |
| 201 | Created - Resource created successfully |
| 204 | No Content - Delete succeeded |
| 400 | Bad Request - Invalid data |
| 401 | Unauthorized - Invalid or missing token |
| 403 | Forbidden - Insufficient permissions |
| 404 | Not Found - Resource doesn't exist |
| 500 | Internal Server Error |

---

## Rate Limiting

**Current Status:** Not implemented

**Future Implementation:** Consider adding rate limiting for production use.

---

## Pagination

All list endpoints support pagination with 50 items per page (default).

**Configuration:** portal/settings.py:166-167

### Pagination Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `page` | integer | Page number (1-indexed) |
| `page_size` | integer | Items per page (max: 100) |

### Paginated Response Format

```json
{
  "count": 150,
  "next": "https://portal.monoliet.cloud/api/workflows/?page=2",
  "previous": null,
  "results": [
    { /* workflow object */ },
    { /* workflow object */ },
    ...
  ]
}
```

### Example Request

```
GET /api/workflows/?page=2&page_size=25
```

---

## Filtering & Search

### Query Parameters

Django Filter Backend enabled (portal/settings.py:168-170)

**Common Filters:**
- `status` - Filter by status field
- `client` - Filter by client UUID
- `search` - Full-text search

### Example Requests

```
GET /api/workflows/?status=active
GET /api/workflows/?client=a1b2c3d4-5678-90ab-cdef-1234567890ab
GET /api/clients/?search=Acme
```

**Implementation:** clients/views.py (filterset_fields, search_fields attributes)

---

## API Endpoints

### Authentication Endpoints

#### POST /api/auth/token/
**Description:** Obtain authentication token
**Authentication:** None required
**Permissions:** Public
**Request Body:**
```json
{
  "username": "string",
  "password": "string"
}
```
**Response:** See [Obtaining a Token](#obtaining-a-token)
**Code Reference:** clients/views.py:371-398

#### POST /api/auth/logout/
**Description:** Revoke authentication token
**Authentication:** Token required
**Permissions:** Authenticated users
**Response:** `{"message": "Successfully logged out"}`
**Code Reference:** clients/views.py:401-409

---

### Clients Endpoints

**Base Path:** `/api/clients/`
**Code Reference:** clients/views.py:38-98

#### GET /api/clients/
**Description:** List all clients (admin only)
**Authentication:** Token required
**Permissions:** Admin users (`IsAdminUser`)
**Query Parameters:**
- `status` - Filter by status (active, paused, churned)
- `plan_tier` - Filter by plan tier
- `billing_cycle` - Filter by billing cycle (monthly, yearly)
- `search` - Search company_name, contact_name, email
- `ordering` - Sort by fields (e.g., `-created_at`, `company_name`)

**Success Response (200 OK):**
```json
{
  "count": 25,
  "next": "...",
  "previous": null,
  "results": [
    {
      "id": "a1b2c3d4-5678-90ab-cdef-1234567890ab",
      "company_name": "Acme Corporation",
      "contact_name": "John Doe",
      "email": "john@acme.com",
      "phone": "+1-555-0100",
      "status": "active",
      "plan_tier": "E-commerce Essentials",
      "setup_fee": "500.00",
      "monthly_fee": "299.00",
      "billing_cycle": "monthly",
      "next_billing_date": "2024-02-01",
      "notes": "Internal notes here",
      "workflows_count": 5,
      "active_workflows_count": 4,
      "created_at": "2024-01-01T00:00:00Z",
      "updated_at": "2024-01-15T10:30:00Z"
    }
  ]
}
```

**Field Descriptions:**
- `id` (UUID) - Unique client identifier
- `company_name` (string) - Company name
- `contact_name` (string) - Primary contact person
- `email` (string) - Contact email (unique)
- `phone` (string, optional) - Contact phone number
- `status` (string) - active | paused | churned
- `plan_tier` (string) - Plan tier name
- `setup_fee` (decimal) - One-time setup fee
- `monthly_fee` (decimal) - Recurring monthly fee
- `billing_cycle` (string) - monthly | yearly
- `next_billing_date` (date) - Next billing date (YYYY-MM-DD)
- `notes` (string) - Internal admin notes (hidden from clients)
- `workflows_count` (integer) - Total workflows count
- `active_workflows_count` (integer) - Active workflows count
- `created_at` (datetime) - Creation timestamp
- `updated_at` (datetime) - Last update timestamp

**Serializer:** clients/serializers.py:16-39

#### GET /api/clients/me/
**Description:** Get current authenticated user's client
**Authentication:** Token required
**Permissions:** Client users (`IsClientUser`)

**Success Response (200 OK):**
```json
{
  "id": "a1b2c3d4-5678-90ab-cdef-1234567890ab",
  "company_name": "Acme Corporation",
  "contact_name": "John Doe",
  "email": "john@acme.com",
  "phone": "+1-555-0100",
  "status": "active",
  "plan_tier": "E-commerce Essentials",
  "billing_cycle": "monthly",
  "workflows_count": 5,
  "created_at": "2024-01-01T00:00:00Z"
}
```

**Note:** Limited serializer excludes `setup_fee`, `monthly_fee`, `notes` (clients/serializers.py:41-57)

**Code Reference:** clients/views.py:81-97

#### GET /api/clients/{id}/
**Description:** Get specific client details
**Authentication:** Token required
**Permissions:** Admin or client owner (`IsClientOwner`)

**Response:** Same as GET /api/clients/ but single object

**Code Reference:** clients/views.py:38-98

#### POST /api/clients/
**Description:** Create new client
**Authentication:** Token required
**Permissions:** Admin only (`IsAdminUser`)

**Request Body:**
```json
{
  "company_name": "New Company Inc",
  "contact_name": "Jane Smith",
  "email": "jane@newcompany.com",
  "phone": "+1-555-0200",
  "status": "active",
  "plan_tier": "Business Process",
  "setup_fee": "750.00",
  "monthly_fee": "499.00",
  "billing_cycle": "monthly",
  "next_billing_date": "2024-03-01",
  "notes": "New client onboarding"
}
```

**Success Response (201 Created):** Full client object with generated `id`

**Code Reference:** clients/views.py:38-98

#### PUT/PATCH /api/clients/{id}/
**Description:** Update client (full or partial)
**Authentication:** Token required
**Permissions:** Admin or client owner (`IsClientOwner`)

**Request Body:** Same as POST (partial for PATCH)
**Success Response (200 OK):** Updated client object

**Code Reference:** clients/views.py:38-98

#### DELETE /api/clients/{id}/
**Description:** Delete client
**Authentication:** Token required
**Permissions:** Admin only (`IsAdminUser`)

**Success Response (204 No Content)**

---

### Workflows Endpoints

**Base Path:** `/api/workflows/`
**Code Reference:** clients/views.py:100-152

#### GET /api/workflows/
**Description:** List workflows (filtered by user permissions)
**Authentication:** Token required
**Permissions:** Admin or client owner
**Query Parameters:**
- `status` - Filter by status (active, paused, error)
- `client` - Filter by client UUID
- `search` - Search workflow_name, n8n_workflow_id

**Success Response (200 OK):**
```json
{
  "count": 10,
  "results": [
    {
      "id": "b2c3d4e5-6789-01ab-cdef-234567890abc",
      "client": "a1b2c3d4-5678-90ab-cdef-1234567890ab",
      "client_name": "Acme Corporation",
      "workflow_name": "Shopify Order Processing",
      "n8n_workflow_id": "123",
      "description": "Processes new Shopify orders automatically",
      "status": "active",
      "last_execution": "2024-01-17T08:30:00Z",
      "execution_count": 1500,
      "success_rate": 98.5,
      "created_at": "2024-01-01T00:00:00Z",
      "updated_at": "2024-01-17T08:30:00Z"
    }
  ]
}
```

**Field Descriptions:**
- `id` (UUID) - Workflow identifier
- `client` (UUID) - Client foreign key
- `client_name` (string) - Client company name (read-only)
- `workflow_name` (string) - Workflow name
- `n8n_workflow_id` (string) - n8n workflow ID (unique)
- `description` (string, optional) - Workflow description
- `status` (string) - active | paused | error
- `last_execution` (datetime, optional) - Last execution time
- `execution_count` (integer) - Total executions count (read-only)
- `success_rate` (float, optional) - Success rate % from last 30 execution records (read-only)
- `created_at` (datetime) - Creation timestamp
- `updated_at` (datetime) - Last update timestamp

**Note:** `success_rate` calculated from last 30 execution records (clients/serializers.py:73-85)

**Serializer:** clients/serializers.py:59-86

#### GET /api/workflows/{id}/
**Description:** Get specific workflow details
**Authentication:** Token required
**Permissions:** Admin or client owner

**Response:** Single workflow object

#### POST /api/workflows/
**Description:** Create new workflow
**Authentication:** Token required
**Permissions:** Admin only (`IsAdminUser`)

**Request Body:**
```json
{
  "client": "a1b2c3d4-5678-90ab-cdef-1234567890ab",
  "workflow_name": "New Automation Workflow",
  "n8n_workflow_id": "456",
  "description": "Description here",
  "status": "active"
}
```

**Success Response (201 Created):** Full workflow object

**Note:** `n8n_workflow_url` auto-generated from `n8n_workflow_id` (clients/models.py:102-105)

#### PATCH /api/workflows/{id}/activate/
**Description:** Activate or pause a workflow
**Authentication:** Token required
**Permissions:** Admin only (`IsAdminUser`)

**Request Body:**
```json
{
  "status": "active"
}
```
_OR_
```json
{
  "status": "paused"
}
```

**Success Response (200 OK):** Updated workflow object

**Error Response (400 Bad Request):**
```json
{
  "error": "Status must be either \"active\" or \"paused\""
}
```

**Code Reference:** clients/views.py:136-151

#### PUT/PATCH /api/workflows/{id}/
**Description:** Update workflow
**Authentication:** Token required
**Permissions:** Admin only

**Request Body:** Same as POST (partial for PATCH)

#### DELETE /api/workflows/{id}/
**Description:** Delete workflow
**Authentication:** Token required
**Permissions:** Admin only

**Success Response (204 No Content)**

---

### Executions Endpoints

**Base Path:** `/api/executions/`
**Code Reference:** clients/views.py:194-262

#### GET /api/executions/
**Description:** List execution records (filtered by user permissions)
**Authentication:** Token required
**Permissions:** Admin or client owner
**Query Parameters:**
- `execution_date` - Filter by date (YYYY-MM-DD)
- `client` - Filter by client UUID
- `workflow` - Filter by workflow UUID

**Success Response (200 OK):**
```json
{
  "count": 100,
  "results": [
    {
      "id": "c3d4e5f6-7890-12ab-cdef-34567890abcd",
      "client": "a1b2c3d4-5678-90ab-cdef-1234567890ab",
      "client_name": "Acme Corporation",
      "workflow": "b2c3d4e5-6789-01ab-cdef-234567890abc",
      "workflow_name": "Shopify Order Processing",
      "execution_date": "2024-01-17",
      "total_count": 50,
      "success_count": 49,
      "error_count": 1,
      "success_rate": 98.0,
      "created_at": "2024-01-17T23:59:00Z"
    }
  ]
}
```

**Field Descriptions:**
- `id` (UUID) - Execution record identifier
- `client` (UUID) - Client foreign key
- `client_name` (string) - Client company name (read-only)
- `workflow` (UUID) - Workflow foreign key
- `workflow_name` (string) - Workflow name (read-only)
- `execution_date` (date) - Date of executions (YYYY-MM-DD)
- `total_count` (integer) - Total executions on this date
- `success_count` (integer) - Successful executions
- `error_count` (integer) - Failed executions
- `success_rate` (float) - Success percentage (read-only)
- `created_at` (datetime) - Record creation timestamp

**Note:** Unique constraint on (workflow, execution_date) (clients/models.py:164)

**Serializer:** clients/serializers.py:123-143

#### GET /api/executions/stats/
**Description:** Get aggregated execution statistics for a time period
**Authentication:** Token required
**Permissions:** Admin or client owner
**Query Parameters:**
- `days` (integer, default: 30) - Number of days to include in statistics

**Success Response (200 OK):**
```json
{
  "total_executions": 15000,
  "total_successes": 14750,
  "total_errors": 250,
  "success_rate": 98.33,
  "period_start": "2023-12-18",
  "period_end": "2024-01-17"
}
```

**Code Reference:** clients/views.py:227-261

#### POST /api/executions/
**Description:** Create execution record
**Authentication:** Token required
**Permissions:** Admin only

**Request Body:**
```json
{
  "client": "a1b2c3d4-5678-90ab-cdef-1234567890ab",
  "workflow": "b2c3d4e5-6789-01ab-cdef-234567890abc",
  "execution_date": "2024-01-17",
  "total_count": 50,
  "success_count": 49,
  "error_count": 1
}
```

**Success Response (201 Created):** Full execution object

---

### Invoices Endpoints

**Base Path:** `/api/invoices/`
**Code Reference:** clients/views.py:264-308

#### GET /api/invoices/
**Description:** List invoices (filtered by user permissions)
**Authentication:** Token required
**Permissions:** Admin or client owner
**Query Parameters:**
- `status` - Filter by status (pending, paid, overdue)
- `type` - Filter by type (setup, monthly, additional)
- `client` - Filter by client UUID
- `search` - Search invoice_number

**Success Response (200 OK):**
```json
{
  "count": 20,
  "results": [
    {
      "id": "d4e5f6g7-8901-23ab-cdef-4567890abcde",
      "client": "a1b2c3d4-5678-90ab-cdef-1234567890ab",
      "client_name": "Acme Corporation",
      "invoice_number": "INV-2024-001",
      "amount": "299.00",
      "type": "monthly",
      "status": "paid",
      "due_date": "2024-01-31",
      "paid_date": "2024-01-25",
      "is_overdue": false,
      "stripe_invoice_id": "in_1234567890",
      "created_at": "2024-01-01T00:00:00Z",
      "updated_at": "2024-01-25T14:30:00Z"
    }
  ]
}
```

**Field Descriptions:**
- `id` (UUID) - Invoice identifier
- `client` (UUID) - Client foreign key
- `client_name` (string) - Client company name (read-only)
- `invoice_number` (string) - Auto-generated invoice number (read-only)
- `amount` (decimal) - Invoice amount
- `type` (string) - setup | monthly | additional
- `status` (string) - pending | paid | overdue
- `due_date` (date) - Payment due date (YYYY-MM-DD)
- `paid_date` (date, optional) - Payment received date
- `is_overdue` (boolean) - True if pending and past due_date (read-only)
- `stripe_invoice_id` (string, optional) - Stripe invoice reference
- `created_at` (datetime) - Creation timestamp
- `updated_at` (datetime) - Last update timestamp

**Note:** Invoice number auto-generated via signal (clients/signals.py, clients/utils.py:65-91)

**Serializer:** clients/serializers.py:155-173

#### GET /api/invoices/{id}/
**Description:** Get specific invoice details
**Authentication:** Token required
**Permissions:** Admin or client owner

**Response:** Single invoice object

#### GET /api/invoices/{id}/download/
**Description:** Download invoice as PDF
**Authentication:** Token required
**Permissions:** Admin or client owner

**Success Response (200 OK):**
```json
{
  "message": "PDF generation not yet implemented",
  "invoice_number": "INV-2024-001"
}
```

**Note:** PDF generation placeholder (clients/views.py:299-307)

**Code Reference:** clients/views.py:298-307

#### POST /api/invoices/
**Description:** Create new invoice
**Authentication:** Token required
**Permissions:** Admin only

**Request Body:**
```json
{
  "client": "a1b2c3d4-5678-90ab-cdef-1234567890ab",
  "amount": "299.00",
  "type": "monthly",
  "status": "pending",
  "due_date": "2024-02-28"
}
```

**Success Response (201 Created):** Full invoice object with auto-generated `invoice_number`

#### PUT/PATCH /api/invoices/{id}/
**Description:** Update invoice
**Authentication:** Token required
**Permissions:** Admin only

**Request Body:** Same as POST (partial for PATCH)

#### DELETE /api/invoices/{id}/
**Description:** Delete invoice
**Authentication:** Token required
**Permissions:** Admin only

**Success Response (204 No Content)**

---

### Support Tickets Endpoints

**Base Path:** `/api/support-tickets/`
**Code Reference:** clients/views.py:310-369

#### GET /api/support-tickets/
**Description:** List support tickets (filtered by user permissions)
**Authentication:** Token required
**Permissions:** Admin or client owner
**Query Parameters:**
- `status` - Filter by status (open, in_progress, resolved)
- `priority` - Filter by priority (low, medium, high)
- `client` - Filter by client UUID
- `search` - Search subject, description

**Success Response (200 OK):**
```json
{
  "count": 15,
  "results": [
    {
      "id": "e5f6g7h8-9012-34ab-cdef-567890abcdef",
      "client": "a1b2c3d4-5678-90ab-cdef-1234567890ab",
      "client_name": "Acme Corporation",
      "subject": "Workflow not triggering",
      "description": "The Shopify order workflow stopped triggering after...",
      "status": "in_progress",
      "priority": "high",
      "days_open": 2,
      "resolved_at": null,
      "created_at": "2024-01-15T09:00:00Z",
      "updated_at": "2024-01-16T14:00:00Z"
    }
  ]
}
```

**Field Descriptions:**
- `id` (UUID) - Ticket identifier
- `client` (UUID) - Client foreign key
- `client_name` (string) - Client company name (read-only)
- `subject` (string) - Ticket subject/title
- `description` (string) - Detailed description
- `status` (string) - open | in_progress | resolved
- `priority` (string) - low | medium | high
- `days_open` (integer) - Days since creation (or until resolution) (read-only)
- `resolved_at` (datetime, optional) - Resolution timestamp
- `created_at` (datetime) - Creation timestamp
- `updated_at` (datetime) - Last update timestamp

**Serializer:** clients/serializers.py:175-197

#### GET /api/support-tickets/{id}/
**Description:** Get specific ticket details
**Authentication:** Token required
**Permissions:** Admin or client owner

**Response:** Single ticket object

#### POST /api/support-tickets/
**Description:** Create new support ticket
**Authentication:** Token required
**Permissions:** Authenticated users (`CanCreateSupportTicket`)

**Request Body:**
```json
{
  "subject": "Issue with workflow",
  "description": "Detailed description of the issue...",
  "priority": "medium"
}
```

**Note:** `client` field auto-populated for client users (clients/views.py:348-358)

**Success Response (201 Created):** Full ticket object

**Email Trigger:** Sends email to client and admin (clients/signals.py)

**Code Reference:** clients/views.py:348-358

#### PATCH /api/support-tickets/{id}/
**Description:** Update ticket (admin only - typically for status changes)
**Authentication:** Token required
**Permissions:** Admin only (`IsAdminUser`)

**Request Body:**
```json
{
  "status": "resolved"
}
```

**Success Response (200 OK):** Updated ticket object

**Note:** Setting `status` to "resolved" auto-sets `resolved_at` timestamp (clients/views.py:361-368)

**Email Trigger:** Sends resolution email to client when status becomes "resolved" (clients/signals.py)

**Code Reference:** clients/views.py:360-369

#### DELETE /api/support-tickets/{id}/
**Description:** Delete ticket
**Authentication:** Token required
**Permissions:** Admin only

**Success Response (204 No Content)**

---

### API Credentials Endpoints

**Base Path:** `/api/credentials/`
**Code Reference:** clients/views.py:154-192

#### GET /api/credentials/
**Description:** List API credentials (filtered by user permissions)
**Authentication:** Token required
**Permissions:** Admin or client owner
**Query Parameters:**
- `credential_type` - Filter by type (oauth, api_key, basic_auth)
- `status` - Filter by status (active, expired, invalid)
- `client` - Filter by client UUID
- `search` - Search service_name

**Admin Response (200 OK):**
```json
{
  "count": 5,
  "results": [
    {
      "id": "f6g7h8i9-0123-45ab-cdef-67890abcdefg",
      "client": "a1b2c3d4-5678-90ab-cdef-1234567890ab",
      "client_name": "Acme Corporation",
      "service_name": "Shopify",
      "credential_type": "api_key",
      "encrypted_data": "gAAAAABhkK...(encrypted)",
      "status": "active",
      "last_verified": "2024-01-15T10:00:00Z",
      "created_at": "2024-01-01T00:00:00Z",
      "updated_at": "2024-01-15T10:00:00Z"
    }
  ]
}
```

**Client User Response (200 OK):**
```json
{
  "count": 5,
  "results": [
    {
      "id": "f6g7h8i9-0123-45ab-cdef-67890abcdefg",
      "client_name": "Acme Corporation",
      "service_name": "Shopify",
      "credential_type": "api_key",
      "status": "active",
      "last_verified": "2024-01-15T10:00:00Z",
      "created_at": "2024-01-01T00:00:00Z"
    }
  ]
}
```

**Note:** Client users cannot see `encrypted_data` field (clients/serializers.py:106-121)

**Serializers:**
- Admin: clients/serializers.py:88-104
- Client: clients/serializers.py:106-121

#### GET /api/credentials/{id}/
**Description:** Get specific credential details
**Authentication:** Token required
**Permissions:** Admin or client owner

**Response:** Single credential object (with or without `encrypted_data` based on user type)

#### POST /api/credentials/
**Description:** Create new API credential
**Authentication:** Token required
**Permissions:** Admin only (`IsAdminUser`)

**Request Body:**
```json
{
  "client": "a1b2c3d4-5678-90ab-cdef-1234567890ab",
  "service_name": "Google Sheets",
  "credential_type": "oauth",
  "encrypted_data": "encrypted_string_here",
  "status": "active"
}
```

**Note:** Encrypt credentials using `clients.utils.encrypt_credential()` before storing

**Success Response (201 Created):** Full credential object

#### PUT/PATCH /api/credentials/{id}/
**Description:** Update credential
**Authentication:** Token required
**Permissions:** Admin only

**Request Body:** Same as POST (partial for PATCH)

#### DELETE /api/credentials/{id}/
**Description:** Delete credential
**Authentication:** Token required
**Permissions:** Admin only

**Success Response (204 No Content)**

---

## Permissions

### Permission Classes

Defined in clients/permissions.py

| Permission Class | Description | Code Reference |
|------------------|-------------|----------------|
| `IsAdminUser` | User must be staff (is_staff=True) | lines 13-22 |
| `IsClientOwner` | User can only access their own client's data | lines 25-71 |
| `IsClientUser` | User must have associated client | lines 73-96 |
| `ReadOnly` | Only GET, HEAD, OPTIONS allowed | lines 98-105 |
| `IsAdminOrReadOnly` | Read for all, write for admins | lines 108-124 |
| `CanCreateSupportTicket` | Authenticated users can create tickets | lines 126-154 |

### Permission Matrix

| Endpoint | Admin | Client User |
|----------|-------|-------------|
| GET /api/clients/ | ✅ All | ❌ Not allowed |
| GET /api/clients/me/ | ✅ | ✅ Own client |
| GET /api/clients/{id}/ | ✅ All | ✅ Own client only |
| POST/PUT/DELETE /api/clients/ | ✅ | ❌ |
| GET /api/workflows/ | ✅ All | ✅ Own workflows |
| POST/PUT/DELETE /api/workflows/ | ✅ | ❌ |
| PATCH /api/workflows/{id}/activate/ | ✅ | ❌ |
| GET /api/executions/ | ✅ All | ✅ Own executions |
| POST /api/executions/ | ✅ | ❌ |
| GET /api/invoices/ | ✅ All | ✅ Own invoices |
| POST/PUT/DELETE /api/invoices/ | ✅ | ❌ |
| POST /api/support-tickets/ | ✅ | ✅ |
| PATCH /api/support-tickets/{id}/ | ✅ | ❌ Read-only |
| GET /api/credentials/ | ✅ (with encrypted_data) | ✅ (without encrypted_data) |
| POST/PUT/DELETE /api/credentials/ | ✅ | ❌ |

---

## Code Examples

### Python (requests library)

**Authentication:**
```python
import requests

# Login and get token
response = requests.post('https://portal.monoliet.cloud/api/auth/token/', json={
    'username': 'your_username',
    'password': 'your_password'
})
data = response.json()
token = data['token']

# Use token in headers
headers = {
    'Authorization': f'Token {token}',
    'Content-Type': 'application/json'
}

# Get current client
response = requests.get(
    'https://portal.monoliet.cloud/api/clients/me/',
    headers=headers
)
client = response.json()
print(client['company_name'])
```

**List Workflows:**
```python
response = requests.get(
    'https://portal.monoliet.cloud/api/workflows/',
    headers=headers,
    params={'status': 'active'}
)
workflows = response.json()['results']
for workflow in workflows:
    print(f"{workflow['workflow_name']}: {workflow['success_rate']}%")
```

**Create Support Ticket:**
```python
response = requests.post(
    'https://portal.monoliet.cloud/api/support-tickets/',
    headers=headers,
    json={
        'subject': 'Workflow Issue',
        'description': 'The workflow stopped running.',
        'priority': 'high'
    }
)
ticket = response.json()
print(f"Ticket created: {ticket['id']}")
```

**Get Execution Statistics:**
```python
response = requests.get(
    'https://portal.monoliet.cloud/api/executions/stats/',
    headers=headers,
    params={'days': 7}
)
stats = response.json()
print(f"Success rate: {stats['success_rate']}%")
print(f"Total executions: {stats['total_executions']}")
```

### cURL

**Get Token:**
```bash
curl -X POST https://portal.monoliet.cloud/api/auth/token/ \
  -H "Content-Type: application/json" \
  -d '{"username":"your_username","password":"your_password"}'
```

**List Invoices:**
```bash
curl -X GET https://portal.monoliet.cloud/api/invoices/ \
  -H "Authorization: Token your_token_here" \
  -H "Content-Type: application/json"
```

**Create Workflow (Admin):**
```bash
curl -X POST https://portal.monoliet.cloud/api/workflows/ \
  -H "Authorization: Token your_admin_token" \
  -H "Content-Type: application/json" \
  -d '{
    "client": "a1b2c3d4-5678-90ab-cdef-1234567890ab",
    "workflow_name": "New Automation",
    "n8n_workflow_id": "789",
    "description": "Automates XYZ process",
    "status": "active"
  }'
```

**Update Ticket Status (Admin):**
```bash
curl -X PATCH https://portal.monoliet.cloud/api/support-tickets/{id}/ \
  -H "Authorization: Token your_admin_token" \
  -H "Content-Type: application/json" \
  -d '{"status":"resolved"}'
```

### JavaScript (Fetch API)

**Get Token:**
```javascript
const response = await fetch('https://portal.monoliet.cloud/api/auth/token/', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    username: 'your_username',
    password: 'your_password'
  })
});
const data = await response.json();
const token = data.token;
```

**List Workflows:**
```javascript
const response = await fetch('https://portal.monoliet.cloud/api/workflows/', {
  headers: {
    'Authorization': `Token ${token}`,
    'Content-Type': 'application/json'
  }
});
const workflows = await response.json();
console.log(workflows.results);
```

**Create Support Ticket:**
```javascript
const response = await fetch('https://portal.monoliet.cloud/api/support-tickets/', {
  method: 'POST',
  headers: {
    'Authorization': `Token ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    subject: 'Need help with workflow',
    description: 'Detailed description...',
    priority: 'medium'
  })
});
const ticket = await response.json();
console.log(`Ticket ID: ${ticket.id}`);
```

---

## Additional Notes

### Credential Encryption

When creating API credentials, use the utility function to encrypt sensitive data:

**Python Example:**
```python
from clients.utils import encrypt_credential

credential_data = {
    'api_key': 'secret_key_here',
    'api_secret': 'secret_here'
}

encrypted = encrypt_credential(credential_data)
# Store encrypted in APICredential.encrypted_data field
```

**Code Reference:** clients/utils.py:17-37

### Invoice Number Generation

Invoice numbers are auto-generated with format `INV-YYYY-XXX` via Django signals.

**Example:** `INV-2024-001`, `INV-2024-002`, etc.

**Code Reference:** clients/utils.py:65-91, clients/signals.py

### n8n Workflow URL

When creating a workflow, if `n8n_workflow_url` is not provided, it's auto-generated from `n8n_workflow_id`:

```
https://n8n.monoliet.cloud/workflow/{n8n_workflow_id}
```

**Code Reference:** clients/models.py:102-105

---

## Support

For API issues or questions:
- **Email:** info@monoliet.cloud
- **Create Support Ticket:** Use the API or web portal

---

**Last Updated:** 2026-01-17
**API Version:** v1 (implicit)
**Framework:** Django REST Framework 3.14.0
**Django Version:** 5.0.1
